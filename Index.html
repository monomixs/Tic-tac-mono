<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #8BC34A;
            --background-color: #E8F5E9;
            --text-color: #212121;
            --border-color: #A5D6A7;
            --winning-color: #FFEB3B;
            --button-active-color: #388E3C;
            --player-x-color: #E91E63;
            --player-o-color: #2196F3;
            --restart-button: #FF9800;
            --restart-button-hover: #F57C00;
            --screen-bg: white;
            --cell-bg: white;
            --cell-border: var(--primary-color);
            --cell-hover-bg: rgba(76, 175, 80, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .screen {
            display: none;
            background: var(--screen-bg);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 350px;
            width: 100%;
            text-align: center;
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.3s ease;
        }

        .screen.active {
            display: block;
            opacity: 1;
            transform: scale(1);
        }

        h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 40px;
            font-weight: normal;
        }

        h2 {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 40px;
            font-weight: normal;
        }

        .button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px 0;
            width: 100%;
            transition: all 0.3s ease;
            transform: scale(1);
        }

        .button:hover {
            background: var(--button-active-color);
            transform: scale(1.05);
        }

        .button:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }

        .button.orange {
            background: var(--restart-button);
        }

        .button.orange:hover {
            background: var(--restart-button-hover);
            transform: scale(1.05);
        }

        .status {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 30px;
        }

        #game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 30px;
            padding: 15px;
            border: 3px solid var(--primary-color);
            border-radius: 15px;
        }

        #game-board.disabled {
            pointer-events: none;
        }

        .cell {
            width: 70px;
            height: 70px;
            background: var(--cell-bg);
            border: 2px solid var(--cell-border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            transform: scale(1);
        }

        .cell:hover:not(.disabled) {
            background: var(--cell-hover-bg);
            transform: scale(1.05);
        }

        .cell:active:not(.disabled) {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }

        .cell.x {
            color: var(--player-x-color);
            animation: cellAppear 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .cell.o {
            color: var(--player-o-color);
            animation: cellAppear 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .cell.winning {
            background: var(--winning-color);
            animation: winPulse 1s ease-in-out infinite;
            transform: scale(1.1);
        }

        .cell.disabled {
            pointer-events: none;
        }

        @keyframes cellAppear {
            0% {
                opacity: 0;
                transform: scale(0.3) rotate(-10deg);
            }
            70% {
                transform: scale(1.1) rotate(5deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        @keyframes winPulse {
            0%, 100% {
                transform: scale(1.1);
                box-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
            }
            50% {
                transform: scale(1.15);
                box-shadow: 0 0 20px rgba(255, 235, 59, 0.8);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status {
            animation: fadeIn 0.5s ease;
        }

        @media (max-width: 480px) {
            .screen {
                margin: 10px;
                padding: 30px;
                max-width: 300px;
            }
            
            h1, h2 {
                font-size: 1.8rem;
                margin-bottom: 30px;
            }
            
            .cell {
                width: 60px;
                height: 60px;
                font-size: 1.8rem;
            }
            
            .button {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
            
            .status {
                font-size: 1.3rem;
            }

            #theme-toggle {
                top: auto;
                bottom: 20px;
            }
        }

        body.dark-mode {
            --primary-color: #81C784; /* Lighter green */
            --secondary-color: #AED581;
            --background-color: #121212;
            --text-color: #E0E0E0;
            --border-color: #4CAF50;
            --winning-color: #FDD835;
            --button-active-color: #66BB6A;
            --player-x-color: #F06292;
            --player-o-color: #64B5F6;
            --restart-button: #FFA726;
            --restart-button-hover: #FB8C00;
            --screen-bg: #1E1E1E;
            --cell-bg: #2C2C2C;
            --cell-border: var(--primary-color);
            --cell-hover-bg: rgba(129, 199, 132, 0.1);
        }

        #theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: var(--screen-bg);
            color: var(--primary-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        #theme-toggle:hover { transform: scale(1.1); }
        #theme-toggle svg { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; fill: none; }
        body:not(.dark-mode) #theme-toggle .sun { display: none; }
        body:not(.dark-mode) #theme-toggle .moon { display: block; }
        body.dark-mode #theme-toggle .sun { display: block; }
        body.dark-mode #theme-toggle .moon { display: none; }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .popup {
            background: var(--screen-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            text-align: left;
            position: relative;
            animation: popup-appear 0.3s ease-out;
        }

        @keyframes popup-appear {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .popup h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .popup p {
            font-size: 1rem;
            line-height: 1.5;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-color);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .close-button:hover {
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <button id="theme-toggle" title="Toggle theme">
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    </button>

    <!-- Home Screen -->
    <div id="homeScreen" class="screen active">
        <h1>Tic Tac Toe</h1>
        <button class="button" onclick="showModeSelect()">Play</button>
        <button class="button" onclick="showWhatsNew()">What's New</button>
    </div>

    <!-- Mode Selection Screen -->
    <div id="modeScreen" class="screen">
        <h2>Choose Mode</h2>
        <button class="button" onclick="startGame('multiplayer')">Multiplayer</button>
        <button class="button" onclick="showDifficultySelect()">Vs AI</button>
        <button class="button" onclick="showHome()">Back</button>
    </div>

    <!-- Difficulty Selection Screen -->
    <div id="difficultyScreen" class="screen">
        <h2>Choose Difficulty</h2>
        <button class="button" onclick="startGame('ai', 'impossible')">Impossible</button>
        <button class="button" onclick="startGame('ai', 'kids')">Kids Mode</button>
        <button class="button" onclick="showModeSelect()">Back</button>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen">
        <div id="leaderboard" style="display: none; margin-bottom: 20px;">
            <h2 style="font-size: 1.5rem; color: var(--primary-color);">
                <span>You: <span id="player-score">0</span></span>
                <span style="margin-left: 20px;">AI: <span id="ai-score">0</span></span>
            </h2>
        </div>
        <h1 id="game-title">Tic Tac Toe</h1>
        
        <div class="status" id="status">Player X's Turn</div>

        <div id="game-board">
            <div class="cell" data-index="0" onclick="makeMove(0)"></div>
            <div class="cell" data-index="1" onclick="makeMove(1)"></div>
            <div class="cell" data-index="2" onclick="makeMove(2)"></div>
            <div class="cell" data-index="3" onclick="makeMove(3)"></div>
            <div class="cell" data-index="4" onclick="makeMove(4)"></div>
            <div class="cell" data-index="5" onclick="makeMove(5)"></div>
            <div class="cell" data-index="6" onclick="makeMove(6)"></div>
            <div class="cell" data-index="7" onclick="makeMove(7)"></div>
            <div class="cell" data-index="8" onclick="makeMove(8)"></div>
        </div>

        <button class="button orange" onclick="resetGame()">Restart</button>
        <button class="button" onclick="showModeSelect()">Mode Select</button>
    </div>

    <div id="whatsNewPopup" class="popup-overlay" style="display: none;">
        <div class="popup">
            <span class="close-button" onclick="hideWhatsNew()">&times;</span>
            <h2>Version 5.37: <strong>AI Update</strong></h2>
            <p style="font-family: sans-serif; border: 1px solid #ccc; padding: 15px; border-radius: 8px; max-width: 600px; margin: 20px auto;">
    <strong style="display: block; font-size: 1.2em; margin-bottom: 10px;">Release Notes: Strategic AI Upgrade</strong>

    <span style="display: block; margin-bottom: 10px;">We've completely overhauled the computer opponent! The old, hardcoded logic has been replaced with the powerful <strong style="color: #007BFF;">Minimax AI</strong>.</span>

    <strong style="display: block; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px;">ðŸ§  Strategic AI Upgrade</strong>
    <ul style="list-style-type: disc; margin: 0; padding-left: 20px;">
        <li style="margin-bottom: 8px;">
            <strong>New AI Logic:</strong> The opponent now uses the <strong style="color: #007BFF;">Minimax algorithm</strong> for decision-making.
        </li>
        <li style="margin-bottom: 8px;">
            <strong>Optimal Play:</strong> The AI can now look ahead multiple moves to determine the <strong style="color: #28a745;">optimal, winning strategy</strong> (or at least the move that guarantees a draw), making the game a much tougher challenge!
        </li>
        <li style="margin-bottom: 0;">
            <strong>New Feature:</strong> Added <strong style="color: #ffc107;">Kids Mode</strong> for an easy win, offering a relaxed experience for all players.
        </li>
    </ul>
</p>
        </div>
    </div>

    <script>
        // Game state
        let board = [[0, 0, 0], [0, 0, 0], [0, 0, 0]];
        const HUMAN = -1;
        const COMP = +1;
        let currentPlayer = 'X';
        let gameActive = true;
        let gameMode = 'multiplayer';
        let playerScore = 0;
        let aiScore = 0;
        let aiDifficulty = 'impossible';

        // Screen navigation
        function showHome() {
            fadeOutCurrentScreen(() => {
                document.getElementById('homeScreen').style.display = 'block';
                document.getElementById('homeScreen').classList.add('active');
            });
        }

        function showModeSelect() {
            playerScore = 0;
            aiScore = 0;
            fadeOutCurrentScreen(() => {
                document.getElementById('modeScreen').style.display = 'block';
                document.getElementById('modeScreen').classList.add('active');
            });
        }

        function showDifficultySelect() {
            fadeOutCurrentScreen(() => {
                document.getElementById('difficultyScreen').style.display = 'block';
                document.getElementById('difficultyScreen').classList.add('active');
            });
        }

        function showWhatsNew() {
            document.getElementById('whatsNewPopup').style.display = 'flex';
        }

        function hideWhatsNew() {
            document.getElementById('whatsNewPopup').style.display = 'none';
        }

        function startGame(mode, difficulty = 'impossible') {
            gameMode = mode;
            aiDifficulty = difficulty;
            resetGame();
            fadeOutCurrentScreen(() => {
                const gameScreen = document.getElementById('gameScreen');
                const leaderboard = document.getElementById('leaderboard');
                const gameTitle = document.getElementById('game-title');

                if (gameMode === 'ai') {
                    leaderboard.style.display = 'block';
                    gameTitle.style.display = 'none';
                    updateLeaderboard();
                } else {
                    leaderboard.style.display = 'none';
                    gameTitle.style.display = 'block';
                }
                gameScreen.style.display = 'block';
                gameScreen.classList.add('active');
            });
        }

        function fadeOutCurrentScreen(callback) {
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen) {
                activeScreen.classList.remove('active');
                setTimeout(() => {
                    activeScreen.style.display = 'none';
                    callback();
                }, 300);
            } else {
                callback();
            }
        }
        
        // Game Logic
        function makeMove(index) {
            if (!gameActive) return;

            const row = Math.floor(index / 3);
            const col = index % 3;

            if (board[row][col] !== 0) return;

            const player = currentPlayer === 'X' ? HUMAN : COMP;
            board[row][col] = player;
            updateCell(index);

            if (checkWin(player)) {
                endGame(currentPlayer);
            } else if (emptyCells(board).length === 0) {
                endGame('draw');
            } else {
                switchPlayer();
                if (gameMode === 'ai' && currentPlayer === 'O') {
                    setTimeout(makeAIMove, 500);
                }
            }
        }

        function makeAIMove() {
            if (!gameActive) return;

            let moveIndex;
            if (aiDifficulty === 'impossible') {
                const move = minimax(board, emptyCells(board).length, COMP);
                moveIndex = move[0] * 3 + move[1];
            } else {
                moveIndex = getKidsMove();
            }

            if (moveIndex !== -1) {
                makeMove(moveIndex);
            }
        }

        function getKidsMove() {
            // 1. Win if possible
            let move = findWinningMove(COMP);
            if (move !== -1) return move;

            // 2. Block if necessary
            move = findWinningMove(HUMAN);
            if (move !== -1) return move;

            // 3. Take center
            if (board[1][1] === 0) return 4;

            // 4. Take a random corner
            const corners = [0, 2, 6, 8];
            const availableCorners = corners.filter(index => {
                const row = Math.floor(index / 3);
                const col = index % 3;
                return board[row][col] === 0;
            });
            if (availableCorners.length > 0) {
                return availableCorners[Math.floor(Math.random() * availableCorners.length)];
            }

            // 5. Take a random available cell
            const availableCells = emptyCells(board).map(cell => cell[0] * 3 + cell[1]);
            if (availableCells.length > 0) {
                return availableCells[Math.floor(Math.random() * availableCells.length)];
            }
            
            return -1; // Should not happen
        }

        function findWinningMove(player) {
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if (board[i][j] === 0) {
                        board[i][j] = player;
                        const hasWon = gameOver(board, player);
                        board[i][j] = 0;
                        if (hasWon) {
                            return i * 3 + j;
                        }
                    }
                }
            }
            return -1;
        }

        // --- MINIMAX AI LOGIC ---
        function evalute(state) {
            if (gameOver(state, COMP)) {
                return +1;
            } else if (gameOver(state, HUMAN)) {
                return -1;
            } else {
                return 0;
            }
        }

        function gameOver(state, player) {
            const win_state = [
                [[0,0], [0,1], [0,2]],
                [[1,0], [1,1], [1,2]],
                [[2,0], [2,1], [2,2]],
                [[0,0], [1,0], [2,0]],
                [[0,1], [1,1], [2,1]],
                [[0,2], [1,2], [2,2]],
                [[0,0], [1,1], [2,2]],
                [[2,0], [1,1], [0,2]],
            ];

            for (let i = 0; i < 8; i++) {
                let line = win_state[i];
                if (state[line[0][0]][line[0][1]] === player &&
                    state[line[1][0]][line[1][1]] === player &&
                    state[line[2][0]][line[2][1]] === player) {
                    return line;
                }
            }
            return null;
        }

        function gameOverAll(state) {
            return gameOver(state, HUMAN) || gameOver(state, COMP);
        }

        function emptyCells(state) {
            let cells = [];
            for (let x = 0; x < 3; x++) {
                for (let y = 0; y < 3; y++) {
                    if (state[x][y] === 0) {
                        cells.push([x, y]);
                    }
                }
            }
            return cells;
        }

        function minimax(state, depth, player) {
            let best;

            if (player === COMP) {
                best = [-1, -1, -Infinity];
            } else {
                best = [-1, -1, +Infinity];
            }

            if (depth === 0 || gameOverAll(state)) {
                let score = evalute(state);
                return [-1, -1, score];
            }

            emptyCells(state).forEach(function (cell) {
                let x = cell[0];
                let y = cell[1];
                state[x][y] = player;
                let score = minimax(state, depth - 1, -player);
                state[x][y] = 0;
                score[0] = x;
                score[1] = y;

                if (player === COMP) {
                    if (score[2] > best[2]) {
                        best = score;
                    }
                } else {
                    if (score[2] < best[2]) {
                        best = score;
                    }
                }
            });

            return best;
        }
        // --- END OF MINIMAX ---

        function checkWin(player) {
            const winningLine = gameOver(board, player);
            if (winningLine) {
                winningLine.forEach(cell => {
                    const index = cell[0] * 3 + cell[1];
                    document.querySelector(`[data-index="${index}"]`).classList.add('winning');
                });
                return true;
            }
            return false;
        }
        
        function updateCell(index) {
            const cell = document.querySelector(`[data-index="${index}"]`);
            cell.textContent = currentPlayer;
            cell.classList.add(currentPlayer.toLowerCase(), 'disabled');
        }

        function switchPlayer() {
            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            updateStatus();
            const gameBoard = document.getElementById('game-board');
            if (gameMode === 'ai') {
                if (currentPlayer === 'O') {
                    gameBoard.classList.add('disabled');
                } else {
                    gameBoard.classList.remove('disabled');
                }
            }
        }

        function updateStatus() {
            const status = document.getElementById('status');
            status.style.animation = 'none';
            setTimeout(() => {
                if (gameMode === 'ai') {
                    status.textContent = currentPlayer === 'X' ? "Your Turn" : "AI's Turn";
                } else {
                    status.textContent = `Player ${currentPlayer}'s Turn`;
                }
                status.style.animation = 'fadeIn 0.5s ease';
            }, 50);
        }

        function updateLeaderboard() {
            document.getElementById('player-score').textContent = playerScore;
            document.getElementById('ai-score').textContent = aiScore;
        }

        function endGame(winner) {
            gameActive = false;
            const status = document.getElementById('status');
            
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.add('disabled');
            });
            
            if (winner === 'draw') {
                status.textContent = "It's a Draw!";
            } else {
                if (gameMode === 'ai') {
                    if (winner === 'X') {
                        playerScore++;
                        status.textContent = "You Win!";
                    } else {
                        aiScore++;
                        status.textContent = "AI Wins!";
                    }
                    updateLeaderboard();
                } else {
                    status.textContent = `Player ${winner} Wins!`;
                }
            }
        }

        function resetGame() {
            board = [[0, 0, 0], [0, 0, 0], [0, 0, 0]];
            currentPlayer = 'X';
            gameActive = true;

            document.getElementById('game-board').classList.remove('disabled');
            
            document.querySelectorAll('.cell').forEach(cell => {
                cell.textContent = '';
                cell.className = 'cell';
            });
            
            updateStatus();
        }

        // Theme switcher logic
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        const prefersDarkQuery = window.matchMedia('(prefers-color-scheme: dark)');

        function applyTheme(isDark) {
            if (isDark) {
                body.classList.add('dark-mode');
            } else {
                body.classList.remove('dark-mode');
            }
        }

        function handleThemePreference() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(savedTheme === 'dark');
            } else {
                applyTheme(prefersDarkQuery.matches);
            }
        }

        themeToggle.addEventListener('click', () => {
            const newThemeIsDark = !body.classList.contains('dark-mode');
            applyTheme(newThemeIsDark);
            localStorage.setItem('theme', newThemeIsDark ? 'dark' : 'light');
        });

        prefersDarkQuery.addEventListener('change', (e) => {
            handleThemePreference();
        });
        
        handleThemePreference();

        // Initial screen setup
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('homeScreen').style.display = 'block';
            document.getElementById('homeScreen').classList.add('active');
        });

    </script>
</body>
</html>